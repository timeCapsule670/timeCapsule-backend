# Invite Code API Documentation

## Overview
The Invite Code API provides functionality for generating, validating, and using invite codes in the TimeCapsule system. This system allows directors (parents/guardians) to invite others to join their family network.

## Base URL
```
/api/invite-codes
```

## Authentication
Most endpoints require authentication via the `Authorization` header:
```
Authorization: Bearer <your-jwt-token>
```

## Endpoints

### 1. Generate Invite Code
**POST** `/api/invite-codes/generate`

Generates a unique invite code for the authenticated director.

**Headers:**
```
Authorization: Bearer <jwt-token>
Content-Type: application/json
```

**Request Body:** None required

**Response:**
```json
{
  "success": true,
  "data": {
    "code": "Joh-456",
    "expiresAt": "2024-01-15T10:30:00.000Z",
    "formattedExpiration": "Jan 15, 2024",
    "message": "Invite code generated successfully"
  }
}
```

**Code Format:** `{first3Letters}-{random3DigitNumber}` (e.g., "Joh-456", "Sar-789")

**Expiration:** 24 hours from generation

**Error Responses:**
- `401`: Unauthorized
- `404`: Director profile not found
- `500`: Server error

---

### 2. Validate Invite Code
**POST** `/api/invite-codes/validate`

Validates an invite code without requiring authentication.

**Headers:**
```
Content-Type: application/json
```

**Request Body:**
```json
{
  "code": "Joh-456"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "isValid": true,
    "isExpired": false,
    "directorName": "John Smith",
    "message": "Invite code is valid"
  }
}
```

**Possible Validation States:**
- **Valid**: Code exists, not used, not expired
- **Invalid**: Code doesn't exist
- **Used**: Code has already been used
- **Expired**: Code has passed expiration time

**Error Responses:**
- `400`: Invalid request body
- `500`: Server error

---

### 3. Use Invite Code
**POST** `/api/invite-codes/use`

Uses an invite code to create a relationship between users.

**Headers:**
```
Content-Type: application/json
```

**Request Body:**
```json
{
  "code": "Joh-456",
  "userId": "user-uuid-here"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "message": "Invite code used successfully",
    "directorId": "director-uuid-here",
    "relationshipCreated": true
  }
}
```

**What Happens:**
1. Validates the invite code
2. Marks code as used
3. Creates director-actor relationship
4. Returns success confirmation

**Error Responses:**
- `400`: Invalid code or already used/expired
- `500`: Server error

---

### 4. Get My Invite Codes
**GET** `/api/invite-codes/my-codes`

Retrieves all invite codes generated by the authenticated director.

**Headers:**
```
Authorization: Bearer <jwt-token>
```

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid-here",
             "code": "Joh-456",
      "director_id": "director-uuid",
      "created_by": "user-uuid",
      "expires_at": "2024-01-15T10:30:00.000Z",
      "is_used": false,
      "used_by": null,
      "used_at": null,
      "created_at": "2024-01-14T10:30:00.000Z",
      "updated_at": "2024-01-14T10:30:00.000Z"
    }
  ]
}
```

**Error Responses:**
- `401`: Unauthorized
- `404`: Director profile not found
- `500`: Server error

---

### 5. Revoke Invite Code
**DELETE** `/api/invite-codes/:codeId`

Revokes an unused invite code.

**Headers:**
```
Authorization: Bearer <jwt-token>
```

**URL Parameters:**
- `codeId`: UUID of the invite code to revoke

**Response:**
```json
{
  "success": true,
  "message": "Invite code revoked successfully"
}
```

**Error Responses:**
- `401`: Unauthorized
- `403`: Permission denied
- `404`: Code not found
- `400`: Cannot revoke used code
- `500`: Server error

---

## Frontend Integration

### Replacing Frontend Logic
Instead of the current frontend code generation, your frontend should now:

1. **Call the backend** to generate codes:
```typescript
const generateInviteCode = async () => {
  try {
    const response = await fetch('/api/invite-codes/generate', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${session.access_token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const result = await response.json();
    if (result.success) {
      setInviteCode(result.data.code);
      setExpirationDate(result.data.formattedExpiration);
    }
  } catch (error) {
    console.error('Error generating invite code:', error);
    generateFallbackCode();
  }
};
```

2. **Use backend validation** for real-time checking:
```typescript
const validateCode = async (code: string) => {
  try {
    const response = await fetch('/api/invite-codes/validate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code })
    });
    
    const result = await response.json();
    return result.data;
  } catch (error) {
    console.error('Validation error:', error);
    return { isValid: false, message: 'Validation failed' };
  }
};
```

### Benefits of Backend Implementation
1. **Centralized Logic**: All code generation happens server-side
2. **Database Storage**: Codes are tracked and can be managed
3. **Security**: Proper validation and access control
4. **Audit Trail**: Track who generated and used codes
5. **Expiration Management**: Automatic expiration handling
6. **Relationship Creation**: Automatic family connection setup

---

## Database Schema

### invite_codes Table
```sql
CREATE TABLE invite_codes (
  id UUID PRIMARY KEY,
  code VARCHAR(50) UNIQUE NOT NULL,
  director_id UUID REFERENCES directors(id),
  created_by UUID REFERENCES auth.users(id),
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  is_used BOOLEAN DEFAULT FALSE,
  used_by UUID REFERENCES auth.users(id),
  used_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Key Features
- **Unique Codes**: Each code is unique across the system
- **Expiration**: 24-hour automatic expiration
- **Usage Tracking**: Track when and by whom codes are used
- **Relationships**: Automatic director-actor relationship creation
- **Security**: Row-level security policies

---

## Error Handling

### Common Error Codes
- `400`: Bad Request (validation errors)
- `401`: Unauthorized (missing/invalid token)
- `403`: Forbidden (insufficient permissions)
- `404`: Not Found (resource doesn't exist)
- `409`: Conflict (code already used)
- `500`: Internal Server Error

### Error Response Format
```json
{
  "success": false,
  "error": "Error message description"
}
```

---

## Rate Limiting & Security

### Security Features
- **Authentication Required**: Most endpoints require valid JWT
- **Row-Level Security**: Database-level access control
- **Input Validation**: Comprehensive request validation
- **SQL Injection Protection**: Parameterized queries

### Rate Limiting
Consider implementing rate limiting for:
- Code generation (e.g., max 10 codes per hour per user)
- Code validation (e.g., max 100 validations per hour per IP)
- Code usage (e.g., max 5 attempts per hour per IP)

---

## Testing Examples

### Generate Code
```bash
curl -X POST http://localhost:3000/api/invite-codes/generate \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json"
```

### Validate Code
```bash
curl -X POST http://localhost:3000/api/invite-codes/validate \
  -H "Content-Type: application/json" \
  -d '{"code": "Joh-456"}'
```

### Use Code
```bash
curl -X POST http://localhost:3000/api/invite-codes/use \
  -H "Content-Type: application/json" \
  -d '{"code": "Joh-456", "userId": "user-uuid"}'
```

---

## Next Steps

1. **Run the SQL script** in your Supabase database
2. **Test the endpoints** using the examples above
3. **Update your frontend** to use these new endpoints
4. **Remove client-side code generation** logic
5. **Test the complete flow** from generation to usage

The backend now handles all the complexity of invite code management while maintaining the same user experience your frontend currently provides.
